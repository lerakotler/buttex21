<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Оформление заказа - ТехноДом</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <header>
        <div class="container header-container">
            <div class="logo">
                <a href="../index.html">
                    <i class="fas fa-home"></i>
                    <span>ТехноДом</span>
                </a>
            </div>
            
            <nav>
                <ul>
                    <li><a href="../index.html"><i class="fas fa-home"></i> Главная</a></li>
                    <li><a href="catalog.html"><i class="fas fa-list"></i> Каталог</a></li>
                    <li><a href="cart.html"><i class="fas fa-shopping-cart"></i> Корзина <span class="cart-count">0</span></a></li>
                    <li><a href="favorites.html"><i class="fas fa-heart"></i> Избранное <span class="fav-count">0</span></a></li>
                </ul>
            </nav>
            
            <div class="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="checkout-header">
            <h1>Оформление заказа</h1>
            <div class="checkout-steps">
                <div class="step active">
                    <span class="step-number">1</span>
                    <span class="step-text">Данные покупателя</span>
                </div>
                <div class="step">
                    <span class="step-number">2</span>
                    <span class="step-text">Способ оплаты</span>
                </div>
                <div class="step">
                    <span class="step-number">3</span>
                    <span class="step-text">Подтверждение</span>
                </div>
            </div>
        </div>
        
        <div class="checkout-container">
            <div class="checkout-form-section" id="customer-data">
                <h2>Данные покупателя</h2>
                
                <div class="checkout-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Имя *</label>
                            <input type="text" id="checkout-firstname" required>
                        </div>
                        <div class="form-group">
                            <label>Фамилия *</label>
                            <input type="text" id="checkout-lastname" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" id="checkout-email" required>
                        </div>
                        <div class="form-group">
                            <label>Телефон *</label>
                            <input type="tel" id="checkout-phone" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Адрес доставки</label>
                        <textarea id="checkout-address" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Комментарий к заказу</label>
                        <textarea id="checkout-comment" rows="3" placeholder="Дополнительные пожелания..."></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <a href="cart.html" class="btn-outline">Вернуться в корзину</a>
                        <button class="btn-primary" onclick="goToPayment()">Перейти к оплате</button>
                    </div>
                </div>
            </div>
            
            <div class="checkout-summary">
                <h3>Ваш заказ</h3>
                <div class="checkout-items" id="checkout-items">
                    <!-- Товары загружаются через JS -->
                </div>
                
                <div class="checkout-totals">
                    <div class="total-row">
                        <span>Товары</span>
                        <span id="subtotal-checkout">0 ₽</span>
                    </div>
                    <div class="total-row">
                        <span>Доставка</span>
                        <span id="delivery-checkout">0 ₽</span>
                    </div>
                    <div class="total-row">
                        <span>Скидка</span>
                        <span id="discount-checkout">0 ₽</span>
                    </div>
                    <div class="total-row total-final">
                        <span>Итого к оплате</span>
                        <span id="total-checkout">0 ₽</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Шаг оплаты -->
        <div class="checkout-form-section" id="payment-section" style="display: none;">
            <h2>Выберите способ оплаты</h2>
            
            <div class="payment-methods">
                <div class="payment-method">
                    <input type="radio" name="payment" id="card-payment" checked>
                    <label for="card-payment">
                        <i class="fas fa-credit-card"></i>
                        <div>
                            <h4>Банковская карта</h4>
                            <p>Оплата онлайн банковской картой</p>
                        </div>
                    </label>
                </div>
                
                <div class="payment-method">
                    <input type="radio" name="payment" id="cash-payment">
                    <label for="cash-payment">
                        <i class="fas fa-money-bill-wave"></i>
                        <div>
                            <h4>Наличными при получении</h4>
                            <p>Оплата курьеру при доставке</p>
                        </div>
                    </label>
                </div>
                
                <div class="payment-method">
                    <input type="radio" name="payment" id="installment-payment">
                    <label for="installment-payment">
                        <i class="fas fa-calendar-alt"></i>
                        <div>
                            <h4>Рассрочка</h4>
                            <p>Рассрочка 0% на 12 месяцев</p>
                        </div>
                    </label>
                </div>
            </div>
            
            <!-- Форма оплаты картой -->
            <div class="card-payment-form" id="card-form">
                <h3>Данные карты</h3>
                
                <div class="form-group">
                    <label>Номер карты</label>
                    <input type="text" id="card-number" placeholder="0000 0000 0000 0000" maxlength="19">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Срок действия</label>
                        <input type="text" id="card-expiry" placeholder="ММ/ГГ" maxlength="5">
                    </div>
                    <div class="form-group">
                        <label>CVV/CVC</label>
                        <input type="text" id="card-cvv" placeholder="123" maxlength="3">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Имя держателя карты</label>
                    <input type="text" id="card-holder" placeholder="IVAN IVANOV">
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="save-card"> Сохранить карту для будущих покупок
                    </label>
                </div>
            </div>
            
            <div class="form-actions">
                <button class="btn-outline" onclick="backToCustomerData()">Назад</button>
                <button class="btn-primary" onclick="processPayment()">Оплатить</button>
            </div>
        </div>
        
        <!-- Подтверждение заказа -->
        <div class="order-confirmation" id="confirmation-section" style="display: none;">
            <div class="confirmation-content">
                <div class="confirmation-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                
                <h2>Заказ успешно оформлен!</h2>
                
                <div class="order-details">
                    <p><strong>Номер заказа:</strong> <span id="order-number">000001</span></p>
                    <p><strong>Сумма:</strong> <span id="order-total">0 ₽</span></p>
                    <p><strong>Способ оплаты:</strong> <span id="order-payment">Банковская карта</span></p>
                    <p><strong>Статус:</strong> <span class="status processing">В обработке</span></p>
                </div>
                
                <p>На ваш email отправлено подтверждение заказа. Мы свяжемся с вами для уточнения деталей доставки.</p>
                
                <div class="confirmation-actions">
                    <a href="../index.html" class="btn-primary">Вернуться на главную</a>
                    <a href="account.html#orders" class="btn-outline">Мои заказы</a>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container footer-container">
            <div class="footer-section">
                <h3>ТехноДом</h3>
                <p>Магазин качественной бытовой техники с 2010 года</p>
                <div class="social-links">
                    <a href="#"><i class="fab fa-vk"></i></a>
                    <a href="#"><i class="fab fa-telegram"></i></a>
                    <a href="#"><i class="fab fa-whatsapp"></i></a>
                </div>
            </div>
            
            <div class="footer-section">
                <h3>Покупателям</h3>
                <ul>
                    <li><a href="catalog.html">Каталог</a></li>
                    <li><a href="delivery.html">Доставка и оплата</a></li>
                    <li><a href="faq.html">Вопросы и ответы</a></li>
                    <li><a href="contacts.html">Контакты</a></li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h3>Контакты</h3>
                <p><i class="fas fa-phone"></i> 8 (800) 123-45-67</p>
                <p><i class="fas fa-envelope"></i> info@technodom.ru</p>
                <p><i class="fas fa-map-marker-alt"></i> Москва, ул. Техническая, 15</p>
            </div>
        </div>
        
        <div class="footer-bottom">
            <p>&copy; 2024 ТехноДом. Все права защищены.</p>
        </div>
    </footer>

    <script src="../js/script.js"></script>
    <script>
        let checkoutData = {
            customer: {},
            payment: {},
            order: {}
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            updateCartCount();
            updateFavCount();
            loadCheckoutData();
            
            const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
            const nav = document.querySelector('nav ul');
            
            mobileMenuBtn.addEventListener('click', function() {
                nav.classList.toggle('show');
            });
            
            // Загрузка данных пользователя если он авторизован
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (currentUser) {
                const nameParts = currentUser.name.split(' ');
                document.getElementById('checkout-firstname').value = nameParts[0] || '';
                document.getElementById('checkout-lastname').value = nameParts[1] || '';
                document.getElementById('checkout-email').value = currentUser.email || '';
                document.getElementById('checkout-phone').value = currentUser.phone || '';
                document.getElementById('checkout-address').value = currentUser.address || '';
            }
            
            // Форматирование номера карты
            document.getElementById('card-number').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
                let formatted = value.replace(/(\d{4})/g, '$1 ').trim();
                e.target.value = formatted;
            });
            
            // Форматирование срока действия
            document.getElementById('card-expiry').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                e.target.value = value;
            });
        });
        
        function loadCheckoutData() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const products = JSON.parse(localStorage.getItem('products')) || getDefaultProducts();
            const container = document.getElementById('checkout-items');
            
            if (cart.length === 0) {
                window.location.href = 'cart.html';
                return;
            }
            
            let subtotal = 0;
            let itemsHtml = '';
            
            cart.forEach(item => {
                const product = products.find(p => p.id === item.productId);
                if (product) {
                    const itemTotal = product.price * item.quantity;
                    subtotal += itemTotal;
                    
                    itemsHtml += `
                        <div class="checkout-item">
                            <div class="item-image">
                                <img src="${product.image}" alt="${product.name}">
                            </div>
                            <div class="item-details">
                                <h4>${product.name}</h4>
                                <div class="item-price">${product.price.toLocaleString()} ₽ × ${item.quantity}</div>
                            </div>
                            <div class="item-total">${itemTotal.toLocaleString()} ₽</div>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = itemsHtml;
            
            // Расчет итогов
            const freeDeliveryThreshold = 20000;
            let deliveryCost = subtotal >= freeDeliveryThreshold ? 0 : 500;
            
            // Проверка промокода
            const promoCode = localStorage.getItem('activePromoCode');
            let discount = 0;
            
            if (promoCode === 'TECHNO10' && subtotal > 0) {
                discount = subtotal * 0.1;
            } else if (promoCode === 'WELCOME500' && subtotal > 0) {
                discount = 500;
            }
            
            const total = subtotal + deliveryCost - discount;
            
            // Обновление сумм
            document.getElementById('subtotal-checkout').textContent = subtotal.toLocaleString() + ' ₽';
            document.getElementById('delivery-checkout').textContent = 
                deliveryCost === 0 ? 'Бесплатно' : deliveryCost.toLocaleString() + ' ₽';
            document.getElementById('discount-checkout').textContent = 
                discount > 0 ? '-' + discount.toLocaleString() + ' ₽' : '0 ₽';
            document.getElementById('total-checkout').textContent = total.toLocaleString() + ' ₽';
            
            checkoutData.order = {
                subtotal,
                delivery: deliveryCost,
                discount,
                total
            };
        }
        
        function goToPayment() {
            // Сбор данных покупателя
            const customer = {
                firstname: document.getElementById('checkout-firstname').value,
                lastname: document.getElementById('checkout-lastname').value,
                email: document.getElementById('checkout-email').value,
                phone: document.getElementById('checkout-phone').value,
                address: document.getElementById('checkout-address').value,
                comment: document.getElementById('checkout-comment').value,
                date: new Date().toLocaleDateString('ru-RU')
            };
            
            if (!customer.firstname || !customer.lastname || !customer.email || !customer.phone) {
                alert('Пожалуйста, заполните все обязательные поля');
                return;
            }
            
            checkoutData.customer = customer;
            
            // Переход к оплате
            document.getElementById('customer-data').style.display = 'none';
            document.getElementById('payment-section').style.display = 'block';
            
            // Обновление шагов
            updateSteps(2);
        }
        
        function backToCustomerData() {
            document.getElementById('payment-section').style.display = 'none';
            document.getElementById('customer-data').style.display = 'block';
            
            updateSteps(1);
        }
        
        function processPayment() {
            // Сбор данных оплаты
            const paymentMethod = document.querySelector('input[name="payment"]:checked').id;
            let paymentData = {
                method: paymentMethod.replace('-payment', '')
            };
            
            if (paymentMethod === 'card-payment') {
                const cardNumber = document.getElementById('card-number').value.replace(/\s+/g, '');
                const cardExpiry = document.getElementById('card-expiry').value;
                const cardCVV = document.getElementById('card-cvv').value;
                const cardHolder = document.getElementById('card-holder').value;
                
                if (!cardNumber || !cardExpiry || !cardCVV || !cardHolder) {
                    alert('Пожалуйста, заполните все поля данных карты');
                    return;
                }
                
                if (cardNumber.replace(/\s/g, '').length !== 16) {
                    alert('Номер карты должен содержать 16 цифр');
                    return;
                }
                
                paymentData.card = {
                    last4: cardNumber.slice(-4),
                    holder: cardHolder
                };
            }
            
            checkoutData.payment = paymentData;
            
            // Имитация обработки платежа
            setTimeout(() => {
                createOrder();
            }, 1500);
        }
        
        function createOrder() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const products = JSON.parse(localStorage.getItem('products')) || getDefaultProducts();
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            // Создание заказа
            const order = {
                id: Date.now(),
                customer: checkoutData.customer,
                payment: checkoutData.payment,
                items: cart.map(item => {
                    const product = products.find(p => p.id === item.productId);
                    return {
                        productId: item.productId,
                        name: product ? product.name : 'Товар',
                        price: product ? product.price : 0,
                        quantity: item.quantity
                    };
                }),
                subtotal: checkoutData.order.subtotal,
                delivery: checkoutData.order.delivery,
                discount: checkoutData.order.discount,
                total: checkoutData.order.total,
                status: 'processing',
                date: new Date().toLocaleDateString('ru-RU'),
                userId: currentUser ? currentUser.id : null
            };
            
            // Сохранение заказа
            const orders = JSON.parse(localStorage.getItem('orders')) || [];
            orders.push(order);
            localStorage.setItem('orders', JSON.stringify(orders));
            
            // Очистка корзины
            localStorage.removeItem('cart');
            localStorage.removeItem('activePromoCode');
            
            // Обновление количества заказов в статистике
            updateOrderStats();
            
            // Показ подтверждения
            showConfirmation(order);
        }
        
        function showConfirmation(order) {
            document.getElementById('payment-section').style.display = 'none';
            document.getElementById('confirmation-section').style.display = 'block';
            
            // Заполнение данных заказа
            document.getElementById('order-number').textContent = order.id;
            document.getElementById('order-total').textContent = order.total.toLocaleString() + ' ₽';
            
            const paymentMethods = {
                'card': 'Банковская карта',
                'cash': 'Наличными при получении',
                'installment': 'Рассрочка'
            };
            
            document.getElementById('order-payment').textContent = 
                paymentMethods[order.payment.method] || order.payment.method;
            
            updateSteps(3);
            
            // Обновление счетчика корзины
            updateCartCount();
        }
        
        function updateSteps(step) {
            const steps = document.querySelectorAll('.step');
            steps.forEach((s, index) => {
                s.classList.remove('active');
                if (index < step) {
                    s.classList.add('active');
                }
            });
        }
        
        function updateOrderStats() {
            // Обновление статистики заказов для админки
            const stats = JSON.parse(localStorage.getItem('storeStats')) || {
                totalOrders: 0,
                totalRevenue: 0
            };
            
            stats.totalOrders += 1;
            stats.totalRevenue += checkoutData.order.total;
            
            localStorage.setItem('storeStats', JSON.stringify(stats));
        }
    </script>
    
    <style>
        .checkout-header {
            margin-bottom: 40px;
        }
        
        .checkout-steps {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 30px;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--gray);
        }
        
        .step.active {
            color: var(--secondary);
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .step.active .step-number {
            background: var(--secondary);
            color: white;
        }
        
        .checkout-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 40px;
            margin-bottom: 60px;
        }
        
        .checkout-form-section {
            background: white;
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        
        .checkout-summary {
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            align-self: start;
        }
        
        .checkout-items {
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }
        
        .checkout-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--light);
        }
        
        .item-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            overflow: hidden;
            margin-right: 15px;
        }
        
        .item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .item-details {
            flex: 1;
        }
        
        .item-details h4 {
            margin-bottom: 5px;
            font-size: 1rem;
        }
        
        .item-price {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .item-total {
            font-weight: bold;
        }
        
        .checkout-totals {
            border-top: 2px solid var(--light);
            padding-top: 20px;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .total-final {
            font-size: 1.2rem;
            font-weight: bold;
            border-top: 1px solid var(--light);
            padding-top: 15px;
            margin-top: 15px;
        }
        
        .payment-methods {
            margin: 30px 0;
        }
        
        .payment-method {
            margin-bottom: 15px;
        }
        
        .payment-method input {
            display: none;
        }
        
        .payment-method label {
            display: flex;
            align-items: center;
            padding: 20px;
            border: 2px solid var(--light);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .payment-method input:checked + label {
            border-color: var(--secondary);
            background: rgba(52, 152, 219, 0.1);
        }
        
        .payment-method i {
            font-size: 1.5rem;
            color: var(--secondary);
            margin-right: 15px;
        }
        
        .card-payment-form {
            background: var(--light-gray);
            padding: 30px;
            border-radius: var(--border-radius);
            margin: 30px 0;
        }
        
        .form-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        .order-confirmation {
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
        }
        
        .confirmation-icon {
            font-size: 5rem;
            color: var(--success);
            margin-bottom: 30px;
        }
        
        .order-details {
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            text-align: left;
            margin: 30px 0;
        }
        
        .confirmation-actions {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 40px;
        }
        
        @media (max-width: 992px) {
            .checkout-container {
                grid-template-columns: 1fr;
            }
            
            .checkout-steps {
                flex-direction: column;
                align-items: center;
                gap: 20px;
            }
            
            .confirmation-actions {
                flex-direction: column;
            }
        }
    </style>
</body>
</html>
